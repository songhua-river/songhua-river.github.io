---
layout: post
title: 事件驱动
abbrlink: 639e9d87
date: 2021-01-06 20:25:34
categories:
  - Node
tags:
  - Node
---

#### event简单使用

引入event模块，并创建事件对象

```javascript
var events = require('events');
var eventEmitter = new events.eventEmitter();
```

绑定事件处理函数

```javascript
var connctHandler = function connected(){
  console.log('connected')
}

eventEmitter.on('connection',connctHandler)
```

触发事件

```javascript
eventEmitter.emit('connection')
```

#### EventEmitter 与 发布/订阅模式的关系

Node.js 中的 EventEmitter 模块就是用了发布/订阅这种设计模式，发布/订阅 模式在主体与观察者之间引入消息调度中心，主体和观察者之间完全透明，所  有的消息传递过程都通过消息调度中心完成，也就是说具体的业务逻辑代码将会是在消息调度中心内完成。

+ once 方法的实现

```javascript
EventEmitter.prototype.once = function (type, listener) {
    let _this = this;

    //中间函数，在调用完之后立即删除订阅
    function only() {
        listener();
        _this.removeListener(type, only);
    }
    //origin保存原回调的引用，用于remove时的判断
    only.origin = listener;
    this.on(type, only);
};
```

+ 事件循环中的事件是什么情况下产生的？什么情况下触发的？

Node.js 中所有所有异步 I/O 操作在完成时都会发送一个事件到事件队列

Node.js 中许多对象都会分发事件： 一个net.Server 对象会在每次有新连接时触发一个事件，fs.readStream对象会在文件被打开的时候触发一个事件，所有这些产生事件的对象都是events.EventEmitter的实例

！[](0001.png)

关于事件你看图中第三部分，事件循环那里。Node.js 所有的异步 I/O 操作(net.Server， fs.readStream 等)在完成后都会添加一个事件到事件循环的事件队列中。

事件的触发，我们只需要关注图中第三部分，事件循环会在事件队列中取出事件处理。fs.open产生事件的对象都是 events.EventEmitter 的实例，继承了EventEmitter，从事件循环取出事件的时候，触发这个事件和回调函数。

+ 事件类型为error的问题

当 error 被触发时，EventEmitter 规定如果没有响 应的监听器，Node.js 会把它当作异常，退出程序并输出错误信息。

我们一般要为会触发 error 事件的对象设置监听器，避免遇到错误后整个程序崩溃。

+ 可以通过process.on('warning')来获得更具体的信息（emitter、event、eventCount）

+ 打印warn详细内容

```javascript
process.on('warning', (e) => {
  console.log(e);
})
```

#### EventEmitter的应用场景

不能try/catch的错误异常抛出可以使用它

好多常用模块继承自EventEmitter 比如fs模块 net模块

#### 发布/订阅模式与观察者模式

![](0002.png)