---
title: é…ç½®ä¼˜åŒ–
mathjax: true
abbrlink: bef1e5aa
date: 2021-01-21 02:08:38
categories:
  - webpack
tags:
  - å·¥ç¨‹åŒ–
  - webpack
---


##### HMR æ¨¡å—çƒ­æ›¿æ¢

å½“ä¸€ä¸ªæ¨¡å—æ”¹å˜æ—¶é¿å…æ‰€æœ‰çš„æ¨¡å—éƒ½è¢«é‡æ–°ç¼–è¯‘ä¸€æ¬¡ï¼Œåº”è¯¥åªæ›´æ–°ä¿®æ”¹çš„æ¨¡å—

é€šè¿‡ `hot:true` å¼€å¯hmrï¼Œæ­¤æ—¶æ ·å¼æ–‡ä»¶(.css .scss) å¯ä»¥è¿›è¡Œçƒ­æ¨¡å—æ›¿æ¢ï¼Œ`style-loader`å†…éƒ¨çš„å®ç°ï¼Œä½†æ˜¯jsæ–‡ä»¶æ²¡æœ‰å¼€å¯çƒ­æ›¿æ¢ï¼Œè€Œä¸”htmlçš„æ–‡ä»¶ä¹Ÿä¸èƒ½æ›´æ–°äº†

å› ä¸ºçƒ­æ›¿æ¢é˜»æ­¢äº†åˆ·æ–°ï¼Œé€šè¿‡ä¿®æ”¹`webpack.config.js` å…¥å£é…ç½®`entry: ['./src/index.js','./src/index.html'],`,å¯ä»¥é‡æ–°å¼€å¯`index.html`çš„åˆ·æ–°åŠŸèƒ½

å¦å¤– `html`æ–‡ä»¶ä¸éœ€è¦çƒ­æ›¿æ¢çš„åŠŸèƒ½ï¼Œå› ä¸ºæ¯ä¸ªå…¥å£åªå¯¹åº”ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸€å®šè¦é‡æ–°åŠ è½½

`.js`æ–‡ä»¶çš„çƒ­æ›¿æ¢ä¸èƒ½æ˜¯å…¥å£æ–‡ä»¶

```javascript
if (module.hot) {
  module.hot.accept('./print.js', function() {
    console.log('Accepting the updated printMe module!');
    printMe();
  })
}
```

##### source-map

æä¾›æºä»£ç åˆ°ç¼–è¯‘åä»£ç æ˜ å°„çš„æ–¹æ¡ˆï¼Œå¯ä»¥è¿½è¸ªæºä»£ç çš„ä½ç½® é€šè¿‡[devtool](https://webpack.docschina.org/configuration/devtool/#root)é…ç½®

[inline-|hidden-|eval][nosources-][cheap-[module-]]source-map

inline æ„å»ºé€Ÿåº¦å¿«

source-map èƒ½æç¤ºé”™è¯¯ä»£ç å‡†ç¡®ä¿¡æ¯ï¼Œå’Œæºä»£ç ä¸­å‡†ç¡®ä½ç½®ï¼Œä¼šå•ç‹¬ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶

inline-source-map source-mapä¼šå†…åµŒåˆ°ç”Ÿæˆçš„jsæ–‡ä»¶ä¸­ï¼Œåªç”Ÿæˆä¸€ä¸ªå†…è”çš„source-map ï¼Œèƒ½æç¤ºé”™è¯¯ä»£ç å‡†ç¡®ä¿¡æ¯ï¼Œå’Œæºä»£ç ä¸­å‡†ç¡®ä½ç½®

eval-source-map source-mapä¼šå†…åµŒåˆ°ç”Ÿæˆçš„jsæ–‡ä»¶ä¸­,æ¯ä¸ªæ–‡ä»¶éƒ½ä¼šç”Ÿæˆå¯¹åº”çš„source-mapï¼Œå¯ä»¥æç¤ºé”™è¯¯åŸå› ï¼Œä½†ä¸èƒ½è¿½è¸ªåˆ°æºä»£ç ä½ç½®ï¼Œåªä¼šå®šä½åˆ°ç¼–è¯‘åçš„é”™è¯¯ä½ç½®

hidden-source-map source-mapæ–‡ä»¶ä¼šå•ç‹¬ç”Ÿæˆï¼Œå¯ä»¥æç¤ºé”™è¯¯åŸå› ï¼Œä½†ä¸èƒ½è¿½è¸ªåˆ°æºä»£ç ä½ç½®ï¼Œåªä¼šå®šä½åˆ°ç¼–è¯‘åçš„é”™è¯¯ä½ç½®

cheap-source-map åœ¨å¤–éƒ¨å•ç‹¬ç”Ÿæˆï¼Œåªèƒ½æç¤ºåˆ°è¡Œï¼Œå¦‚æœä»£ç åœ¨ä¸€è¡Œä¸­ï¼Œä¸èƒ½å‡†ç¡®çš„å®šä½

cheap-module-source-map åœ¨å¤–éƒ¨å•ç‹¬ç”Ÿæˆ ä¸ cheap-source-map ç±»ä¼¼,ä¼šå°†loaderçš„source-mapåŠ å…¥

nosources-source-map å¯ä»¥æä¾›ä½œç‰©ä¿¡æ¯ï¼Œä½†æ˜¯ä¸èƒ½å®šä½åˆ°é”™è¯¯ä½ç½®ï¼Œæºä»£ç å’Œç¼–è¯‘åä»£ç éƒ½ä¸å¯ä»¥

æ•°åº¦å¿«æ…¢: eval=> inline => cheap

å¼€å‘ç¯å¢ƒï¼šcheap-source-map
  é€Ÿåº¦å¿« 
    eval-cheap-source-map
    eval-source-map ğŸ†š
  è°ƒè¯•å‹å¥½
    source-map
    cheap-module-source-map
    cheap-source-map

ç”Ÿäº§ç¯å¢ƒ
  ç®€å•è°ƒè¯•ï¼Œ
  å†…è”ä¼šè®©ä½“ç§¯å˜å¤§
  nosources-source-map å…¨éƒ¨éšè—ä»£ç ï¼Œåœ¨çº¿ä¸Šç¯å¢ƒä½¿ç”¨ğŸ†š
  hidden-source-map  åªéšè—æºä»£ç 

  source-map ğŸ†š,å•ç‹¬ç”Ÿæˆæ–‡ä»¶ä¸”ä¾¿äºè°ƒè¯•

#### oneOf

ç”¨äºæå‡æ„å»ºçš„é€Ÿåº¦ï¼Œåªè¦æœ‰ä¸€ä¸ªloaderåŒ¹é…åˆ°å°±ä¸ä¼šç»§ç»­åŒ¹é…

```javascript
{
  module: {
    rules: [
      {
        //...
        // æŒ‡å®šä¼˜å…ˆçº§ï¼Œéƒ½ä¼šå…ˆè¢«è¿™ä¸ªloaderå¤„ç†
        enforce:'pre'
      }ï¼Œ
      {
        oneOf:[
          // å…¶ä»–çš„loader
        ]
      }
    ]
  }
}
```


#### ç¼“å­˜

åœ¨ç¼–è¯‘æ–‡ä»¶çš„æ—¶å€™ï¼Œå¦‚æœä¾èµ–æ–‡ä»¶æ²¡æœ‰æ”¹å˜ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ç¼–è¯‘å¥½çš„ç¼“å­˜æ–‡ä»¶ï¼Œæ— éœ€æ‰€æœ‰æ–‡ä»¶éƒ½é‡æ–°ç¼–è¯‘

```javascript
{
  test: /\.js$/i,
  use: [{
    loader: 'babel-loader',
    options:{
      cacheDirectory:true
    }
  }],
},
```

æ–‡ä»¶èµ„æºçš„ç¼“å­˜ 

+ hash å¦‚æœéƒ½ä½¿ç”¨hashçš„è¯ï¼Œå³æ¯æ¬¡ä¿®æ”¹ä»»ä½•ä¸€ä¸ªæ–‡ä»¶ï¼Œæ‰€æœ‰æ–‡ä»¶åçš„hashè‡³éƒ½å°†æ”¹å˜ã€‚æ‰€ä»¥ä¸€æ—¦ä¿®æ”¹äº†ä»»ä½•ä¸€ä¸ªæ–‡ä»¶ï¼Œæ•´ä¸ªé¡¹ç›®çš„æ–‡ä»¶ç¼“å­˜éƒ½å°†å¤±æ•ˆ.

+ chunkhash chunkhashæ ¹æ®ä¸åŒçš„å…¥å£æ–‡ä»¶(Entry)è¿›è¡Œä¾èµ–æ–‡ä»¶è§£æã€æ„å»ºå¯¹åº”çš„chunkï¼Œç”Ÿæˆå¯¹åº”çš„å“ˆå¸Œå€¼ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒé‡ŒæŠŠä¸€äº›å…¬å…±åº“å’Œç¨‹åºå…¥å£æ–‡ä»¶åŒºåˆ†å¼€ï¼Œå•ç‹¬æ‰“åŒ…æ„å»ºï¼Œæ¥ç€æˆ‘ä»¬é‡‡ç”¨chunkhashçš„æ–¹å¼ç”Ÿæˆå“ˆå¸Œå€¼ï¼Œé‚£ä¹ˆåªè¦æˆ‘ä»¬ä¸æ”¹åŠ¨å…¬å…±åº“çš„ä»£ç ï¼Œå°±å¯ä»¥ä¿è¯å…¶å“ˆå¸Œå€¼ä¸ä¼šå—å½±å“ã€‚åŠ¨æ€importä¹Ÿå—chunkhashçš„å½±å“.

å› ä¸ºæˆ‘ä»¬æ˜¯å°†æ ·å¼ä½œä¸ºæ¨¡å—importåˆ°JavaScriptæ–‡ä»¶ä¸­çš„ï¼Œæ‰€ä»¥å®ƒä»¬çš„chunkhashæ˜¯ä¸€è‡´çš„,è¿™æ ·å°±ä¼šæœ‰ä¸ªé—®é¢˜ï¼Œåªè¦å¯¹åº”cssæˆ–åˆ™jsæ”¹å˜ï¼Œä¸å…¶å…³è”çš„æ–‡ä»¶hashå€¼ä¹Ÿä¼šæ”¹å˜ï¼Œä½†å…¶å†…å®¹å¹¶æ²¡æœ‰æ”¹å˜å‘¢ï¼Œæ‰€ä»¥æ²¡æœ‰è¾¾åˆ°ç¼“å­˜æ„ä¹‰ã€‚å›ºcontenthashçš„ç”¨é€”éšä¹‹è€Œæ¥ã€‚

+ contenthashæ˜¯é’ˆå¯¹æ–‡ä»¶å†…å®¹çº§åˆ«çš„ï¼Œåªæœ‰ä½ è‡ªå·±æ¨¡å—çš„å†…å®¹å˜äº†ï¼Œé‚£ä¹ˆhashå€¼æ‰æ”¹å˜


#### tree-shaking

ä½¿ç”¨es6æ¨¡å—åŒ–è§„èŒƒï¼Œå¼€å¯productionæ¨¡å¼ï¼Œwebpackä¼šè‡ªåŠ¨å¯ç”¨tree-shaking

`webpack.config.js` ä¸­æ·»åŠ `sideEffects:false`è¡¨ç¤ºæ‰€æœ‰çš„ä»£ç éƒ½æ²¡æœ‰å‰¯ä½œç”¨ï¼Œå¦‚æœæ ‡è®°ä¸º`false`, å…¨å±€å¼•å…¥çš„æ–‡ä»¶(polyfile),æˆ–æ²¡æœ‰é€šè¿‡æ¨¡å—åŒ–ä½¿ç”¨çš„css,éƒ½ä¼šè¢«åˆ é™¤

å¯ä»¥é€šè¿‡ä¸€ä¸ªæ•°ç»„æ¥æ ‡è®°ä¸éœ€è¦å¤„ç†çš„èµ„æº `sideEffects:['*.css']`

#### ä»£ç åˆ†å‰² code-split

**ç”Ÿæˆchunkçš„å‡ ç§æ–¹å¼**

+ å¤šé¡µé¢entryç”Ÿæˆå¤šä¸ªchunk
+ å¼‚æ­¥ç»„ä»¶ç”Ÿæˆchunk
+ code split 

```javascript
// å°†node-modules ä¸­ä»£ç å•ç‹¬æ‰“åŒ…æˆ
// åˆ†æå¤šå…¥å£æ–‡ä»¶ä¸­æœ‰æ²¡æœ‰å…¬å…±çš„ä¾èµ–ï¼Œä¼šæŠŠä¾èµ–å•ç‹¬æ‰“åŒ…
optimization: {
  splitChunks: {
    chunks: 'all'
  }
},
```

#### æ‡’åŠ è½½ é¢„åŠ è½½

[dynamic-imports](https://webpack.docschina.org/guides/code-splitting/#dynamic-imports)

`babel-loader`ä¼šè‡ªåŠ¨å¤„ç† `dynamic-imports`è¯­æ³•ï¼Œ å¦‚æœ`eslint`æç¤ºé”™è¯¯ï¼Œåœ¨`.eslintrc`ä¸­æ·»åŠ `"parser": "babel-eslint"`

#### PWA

work-box -> [workbox-webpack-plugin](https://developers.google.com/web/tools/workbox/modules/workbox-webpack-plugin)

```javascript
yarn add -D workbox-webpack-plugin
```

`webpack.config.js` ä¸­æ·»åŠ æ’ä»¶å’Œ[é…ç½®é¡¹](https://developers.google.com/web/tools/workbox/reference-docs/latest/module-workbox-webpack-plugin.GenerateSW#GenerateSW)

```javascript
{
  plugins:[
    //...
    new GenerateSW({
      // å¸®åŠ©serviceWorkå¿«é€Ÿå¯åŠ¨ï¼Œ
      // åˆ é™¤æ—§çš„serverwork
      clientsClaim:true,
      skipWaiting:true
    })
  ]
}
```

æ³¨å†Œservicework

åœ¨å…¥å£æ–‡ä»¶`index.js`ä¸­

```javascript
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(() => {
        console.log('æ³¨å†ŒæˆåŠŸ');
      })
      .catch(() => {
        console.log('æ³¨å†Œå¤±è´¥');
      });
  });
}
```

å¦‚æœ`eslint`ä¸æ”¯æŒå…¨å±€å˜é‡,åœ¨`.eslinrc`æ·»åŠ `{env:browser: true,}`

#### å¤šè¿›ç¨‹æ‰“åŒ…

[thread-loader](https://www.npmjs.com/package/thread-loader)

è¿›ç¨‹çš„å¯ç”¨ä¼šå ç”¨æ—¶é—´ï¼ˆå¤§çº¦600msï¼‰ï¼Œåªæœ‰å¤æ‚çš„ä»»åŠ¡å¤„ç†çš„æ—¶å€™æ‰ä¼šæœ‰æ˜æ˜¾çš„æ•ˆæœ


#### externals å¿½ç•¥æŸäº›èµ„æº

åœ¨`webpack.config.js`ä¸­æ·»åŠ [`externals`](https://webpack.docschina.org/configuration/externals/#root)

```javascript
module.exports = {
  //...
  externals: {
    jquery: 'jQuery'
  }
};
```

å’Œdllçš„åŒºåˆ«æ˜¯ï¼Œexternalså¹¶æ²¡æœ‰æ‰“åŒ…æ–‡ä»¶ï¼Œéœ€è¦é€šè¿‡cdnçš„æ–¹å¼å¼•å…¥è¿›æ¥ï¼Œdllåªæ˜¯æŠŠæŒ‡å®šçš„åŒ…å•ç‹¬æ‰“åŒ…ï¼Œå¹¶é€šè¿‡æ’ä»¶æŠŠå•ç‹¬æ‰“åŒ…çš„æ–‡ä»¶é‡æ–°å¼•å…¥

#### dll 

å¯¹ç¬¬ä¸‰æ–¹çš„åº“ï¼Œè¿›è¡Œå•ç‹¬æ‰“åŒ… webpack5ä¸é€‚ç”¨

é€šè¿‡ä¸¤ä»½é…ç½®ï¼Œå¯ä»¥é¿å…æ¯æ¬¡å¯¹ç¬¬ä¸‰æ–¹çš„åº“é‡æ–°æ‰“åŒ…

webpack.dll.js

```javascript
const path = require('path');
const webpack = require('webpack');

module.exports = {
  entry:{
    lodash:['lodash'],
    jquery:['jquery'],
    moment:["moment"]
  },
  output:{
    // ç”Ÿæˆæ–‡ä»¶çš„åç§°
    filename:'[name]_[contenthash:8].js',
    path:path.resolve(__dirname,'dll'),
    // å•ç‹¬æ‰“åŒ…çš„åº“å¯¹å¤–æš´éœ²çš„åç§°
    library: "[name]_[fullhash]"
  },
  plugins:[
    new webpack.DllPlugin({
      context: __dirname,
      // æ˜ å°„å•ç‹¬æ‰“åŒ…çš„åº“çš„åç§°
      name: '[name]_[fullhash]',
      // ç”Ÿæˆçš„manifestæ–‡ä»¶
      path:path.resolve(__dirname,'dll/[name]_manifest.json')
    })
  ],
  mode:'production'
}
```

webpack.config.js

ä½¿ç”¨ [add-asset-html-webpack-plugin](https://www.npmjs.com/package/add-asset-html-webpack-plugin)æŠŠå•ç‹¬æ‰“åŒ…çš„èµ„æºå¼•å…¥

```javascript
module.export = {
  plugins:[
    new webpack.DllReferencePlugin({
      // å­˜åœ¨äºmanifestæ–‡ä»¶ä¸­çš„åŒ…ï¼Œä¸ä¼šè¢«æ‰“åŒ…
			manifest: require(path.resolve(__dirname,'dll/moment_manifest.json'))
    }),
    new webpack.DllReferencePlugin({
			manifest: require(path.resolve(__dirname,'dll/lodash_manifest.json'))
    }),
    new webpack.DllReferencePlugin({
			manifest: require(path.resolve(__dirname,'dll/jquery_manifest.json'))
		}),
    new AddAssetHtmlPlugin({
      filepath: path.resolve(__dirname, './dll/*.js'),
    })
  ]
}

```
